#!/bin/sh
# Patch Passwall to support HTTPUpgrade transport
# Creates .bk backups before modifying
echo "[#] Patch Passwall to support HTTPUpgrade [#]"
echo.
# File paths
UTIL_XRAY="/usr/lib/lua/luci/passwall/util_xray.lua"
SUBSCRIBE="/usr/share/passwall/subscribe.lua"
NODE_CONFIG="/usr/lib/lua/luci/model/cbi/passwall/client/node_config.lua"

# Backup function
backup_file() {
    local file="$1"
    local backup="${file}.bk"
    if [ ! -f "$backup" ]; then
        cp "$file" "$backup"
        echo "[+] Backup file"
    else
        echo "[-] Backup already exists"
    fi
}

# Backup all files first
backup_file "$UTIL_XRAY"
backup_file "$SUBSCRIBE"
backup_file "$NODE_CONFIG"

echo "[+] Patching HTTPUpgrade into Passwall..."
### 1) subscribe.lua patch
if ! grep -q "result.httpupgrade_host" "$SUBSCRIBE"; then
    sed -i '/result.ws_path = params.path/{n;/^[[:space:]]*end[[:space:]]*$/a\
			if params.type == '\''httpupgrade'\'' then\
				result.httpupgrade_host = params.host\
				result.httpupgrade_path = params.path\
			end
}' "$SUBSCRIBE"
fi

### 2) util_xray.lua patches
if ! grep -Fq 'httpupgradeSettings = (node.transport == "httpupgrade") and {' "$UTIL_XRAY"; then
    awk '
    BEGIN { inserted = 0 }
    /^[\t ]*wsSettings[\t ]*=.*$/ {
        ws_line = 1
    }
    /^[\t ]*\} or nil,$/ {
        if (ws_line && !inserted) {
            print $0
            print "    			httpupgradeSettings = (node.transport == \"httpupgrade\") and {"
            print "        			path = node.httpupgrade_path or \"/\","
            print "        			host = node.httpupgrade_host"
            print "    			} or nil,"
            inserted = 1
            ws_line = 0
            next
        }
    }
    { print }
    END {
        if (!inserted) {
            print "Error: Could not find wsSettings block to patch." > "/dev/stderr"
            exit 1
        }
    }
    ' "$UTIL_XRAY" > "$UTIL_XRAY.tmp" && mv "$UTIL_XRAY.tmp" "$UTIL_XRAY"
fi

### 3) node_config.lua patches
# Transport option
if ! grep -q 'transport:value("httpupgrade"' "$NODE_CONFIG"; then
    sed -i '/^[[:space:]]*transport:value("ws", "WebSocket")/a\
transport:value("httpupgrade", "HTTPUpgrade")' "$NODE_CONFIG"
fi

# Config fields
if ! grep -q 'httpupgrade_host' "$NODE_CONFIG"; then
    sed -i '/ws_earlyDataHeaderName:depends("ws_enableEarlyData", true)/a\
\
-- [[ HTTPUpgrade部分 ]]--\
httpupgrade_host = s:option(Value, "httpupgrade_host", translate("HTTPUpgrade Host"))\
httpupgrade_host:depends("transport", "httpupgrade")\
httpupgrade_path = s:option(Value, "httpupgrade_path", translate("HTTPUpgrade Path"))\
httpupgrade_path.placeholder = "/"\
httpupgrade_path:depends("transport", "httpupgrade")\
' "$NODE_CONFIG"
fi

echo.
echo "[#] Passwall + HTTPUpgrade Patch [#]"
